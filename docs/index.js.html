<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const client_s3_1 = require("@aws-sdk/client-s3");
const errors_1 = require("./errors");
const buckets_1 = require("./provider/s3/buckets");
const credentials_1 = require("./provider/s3/credentials");
const schemas_1 = require("./schemas");
/**
 * Cloud Bucket Sync module.
 * @module CloudBucketSync
 * @see cloud-bucket-sync:CloudBucketSync
 */
class CloudBucketSync {
    serverless;
    options;
    hooks;
    servicePath;
    config;
    logging;
    taskProcess;
    client;
    _buckets = [];
    constructor(serverless, options, logging) {
        if (!serverless) {
            throw new Error('Serverless instance is required');
        }
        this.serverless = serverless;
        this.servicePath = this.serverless.service.serverless.config.servicePath;
        if (!options) {
            throw new Error("Options can't be undefined");
        }
        this.options = options;
        if (!logging) {
            throw new Error("Logging can't be undefined");
        }
        this.logging = logging;
        const config = this.serverless.service.custom;
        const validatedConfig = schemas_1.inputCustomSchema.safeParse(config);
        const { success } = validatedConfig;
        if (!success) {
            const { error } = validatedConfig;
            throw new errors_1.InvalidConfigError(error.message, error);
        }
        const { data: validConfig } = validatedConfig;
        this.config = validConfig;
        this.client = this.getS3Client();
        this._buckets = this.config.cloudBucketSync.buckets.filter((bucket) => bucket.enabled);
        this.hooks = this.setHooks();
    }
    getS3Client() {
        const provider = this.serverless.getProvider('aws');
        const s3Options = (0, credentials_1.getCredentials)(provider);
        if (this.config.cloudBucketSync.endpoint &amp;&amp;
            this.config.cloudBucketSync.offline) {
            s3Options.endpoint = this.config.cloudBucketSync.endpoint;
        }
        return new client_s3_1.S3Client(s3Options);
    }
    setHooks() {
        const syncBucketsHook = () => this.buckets();
        const syncTagsHook = () => this.tags();
        return {
            // 'before:offline:start:init': syncBucketsHook,
            // 'before:deploy:deploy': syncBucketsHook,
            'cloudBucketSync:buckets': syncBucketsHook,
            'cloudBucketSync:tags': syncTagsHook,
            initialize: () => syncBucketsHook(),
            'before:deploy:deploy': () => syncBucketsHook(),
            // 'deploy:deploy': () => deploy(),
            // 'after:deploy:deploy': () => afterDeploy(),
        };
    }
    async buckets() {
        if (this.config.cloudBucketSync.disabled) {
            return false;
        }
        this.taskProcess = this.logging.progress.create({
            message: 'Syncing buckets and tags started',
        });
        const syncedBuckets = await Promise.allSettled(this._buckets.map((bucket) => (0, buckets_1.sync)(this.client, bucket)));
        console.log({ syncedBuckets });
        for (const bucket of syncedBuckets) {
            if (bucket.status === 'rejected') {
                throw bucket.reason;
            }
            const { value: objects } = bucket;
            if (objects.uploaded) {
                await this.metadata(objects.uploaded);
            }
        }
        this.taskProcess.update('Buckets successfully synced');
        await this.onExit();
        return true;
    }
    async metadata(objects) {
        return await Promise.allSettled(this._buckets.map((bucket) => (0, buckets_1.syncMetadata)(this.client, bucket, objects)));
    }
    async tags() {
        if (this.config.cloudBucketSync.disabled) {
            return false;
        }
        return await Promise.allSettled(this._buckets.map((bucket) => (0, buckets_1.syncTags)(this.client, bucket)));
    }
    async onExit() {
        if (this.taskProcess) {
            this.taskProcess.remove();
        }
        if (this.client) {
            this.client.destroy();
        }
    }
}
exports.default = CloudBucketSync;
module.exports = CloudBucketSync;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-CloudBucketSync.html">CloudBucketSync</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Sat Jan 20 2024 23:50:26 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
